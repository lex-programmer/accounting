{% extends "core/base.html" %}
{% load static %}

{% block title %}Adaugă / Redactează factură{% endblock %}

{% block content %}
<h2>Adaugă / Redactează factură</h2>

<form method="post" class="styled-form">
  {% csrf_token %}

  <div class="form-group" style="margin-bottom: 15px;">
      <label for="id_contract_is_planned" style="display: flex; align-items: center; cursor: pointer; gap: 5px;">
          {{ form.contract_is_planned }}
          Contractul este planificat?
      </label>
      <input type="checkbox" id="id_contract_is_planned">
  </div>
  <table class="form-table">
    <tr>
      <td><label for="id_numar">Număr factură:</label></td>
      <td>{{ form.numar }}</td>
      <td><label for="id_data_facturii">Data facturii:</label></td>
      <td>{{ form.data_facturii }}</td>
    </tr>
    <tr>
      <td><label for="id_suma_facturii">Suma facturii:</label></td>
      <td>{{ form.suma_facturii }}</td>

      <td id="contract-label-cell"><label for="id_contract">Contract:</label></td>
      <td id="contract-field-cell">{{ form.contract }}</td>

      <td id="eco-label-cell" style="display:none;"><label for="id_eco">Cod ECO:</label></td>
      <td id="eco-field-cell" style="display:none;">{{ form.eco }}</td>
    </tr>

    <tr>
      <td><label for="id_budget_line">Linie bugetară:</label></td>
      <td>{{ form.budget_line }}</td>
      <td><label for="id_valuta">Valuta:</label></td>
      <td>{{ form.valuta }}</td>
    </tr>
    <tr>
      <td><label for="id_comentariu">Descriere (opțional):</label></td>
      <td colspan="3">{{ form.comentariu }}</td>
    </tr>
    </table>

  <div class="form-actions">
    <button type="submit" class="btn btn-primary">Salvează</button>
    <a href="{% url 'factura_list' %}" class="btn btn-secondary">Anulare</a>
  </div>
</form>

{% if error_modal %}
<div id="errorModal" class="modal show-error">
  <div class="modal-content">
    <span class="close-btn" id="closeError">&times;</span>
    <h3 style="color:#e03131; margin-top:0;">Eroare!</h3>
    <p style="font-size:15px;">{{ error_modal|safe }}</p>
    <div style="text-align:right; margin-top:20px;">
      <button id="closeModalBtn" class="btn btn-secondary">Închide</button>
    </div>
  </div>
</div>
{% endif %}

<script>
document.addEventListener('DOMContentLoaded', () => {
  const modal = document.getElementById('errorModal');
  if (modal) {
    modal.style.display = 'flex';
    const closeButtons = [document.getElementById('closeError'), document.getElementById('closeModalBtn')];
    closeButtons.forEach(btn => {
      if (btn) btn.addEventListener('click', () => modal.style.display = 'none');
    });
  }
});
</script>

{% if error_modal %}
  <pre style="color:red;">{{ error_modal }}</pre>

<div class="form-errors">
    {{ form.non_field_errors }}
  </div>
{% endif %}

{% if warnings %}
  <div class="alert alert-warning">
    {% for w in warnings %}
      <p>{{ w }}</p>
    {% endfor %}
  </div>
{% endif %}
{% endblock %}

{% block extra_js %}
<script>
$(document).ready(function() {
    const $checkbox = $('#id_contract_is_planned');

    // Элементы для Contract
    const $contractLabelCell = $('#contract-label-cell');
    const $contractFieldCell = $('#contract-field-cell');
    const $contractField = $('#id_contract');

    // Элементы для ECO
    const $ecoLabelCell = $('#eco-label-cell');
    const $ecoFieldCell = $('#eco-field-cell');
    const $ecoField = $('#id_eco');

    function toggleContractEcoFields() {
        if ($checkbox.is(':checked')) {
            // Сценарий 1: Contractul este planificat? = TRUE
            $contractLabelCell.show();
            $contractFieldCell.show();
            $contractField.prop('disabled', false).val($contractField.attr('data-original-value'));

            // Скрываем ECO
            $ecoLabelCell.hide();
            $ecoFieldCell.hide();
            $ecoField.prop('disabled', true).val('');

        } else {
            // Сценарий 2: Contractul este planificat? = FALSE
            $contractLabelCell.hide();
            $contractFieldCell.hide();

            $contractField.attr('data-original-value', $contractField.val()).val('');
            $contractField.prop('disabled', true);

            // Показываем ECO
            $ecoLabelCell.show();
            $ecoFieldCell.show();
            $ecoField.prop('disabled', false);
        }
    }

    // Сохраняем изначальное состояние (для редактирования)
    $contractField.attr('data-original-value', $contractField.val());

    // 1. Применяем логику при загрузке страницы
    toggleContractEcoFields();

    // 2. Применяем логику при изменении чекбокса
    $checkbox.on('change', toggleContractEcoFields);
});
</script>
{% endblock %}